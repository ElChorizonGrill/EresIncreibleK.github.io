<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>üéÇ Cumplea√±os M√°gico para Keysi ‚Äî Audio Robust Play</title>

  <!-- Google fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Great+Vibes&family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0d0b1a; --card: hsla(0,0%,100%,.88);
      --ink:#171625; --muted:#6d7392;
      --brand:#ff3e86; --brand2:#7c4dff;
      --radius:18px; --shadow: 0 18px 48px rgba(17,14,40,.16);
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:'Plus Jakarta Sans', system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif;background:var(--bg);color:var(--ink);-webkit-font-smoothing:antialiased;}
    /* background decor */
    .bg{position:fixed;inset:0;z-index:0;pointer-events:none;overflow:hidden}
    .blob{position:absolute;filter:blur(40px);opacity:.55;mix-blend-mode:screen}
    .b1{width:60vmax;height:60vmax;background:radial-gradient(closest-side,#ff8ac3 0%,#ffb8d9 40%,transparent 70%);top:-12%;left:-18%;animation:drift 26s ease-in-out infinite}
    .b2{width:70vmax;height:70vmax;background:radial-gradient(closest-side,#6aa8ff 0%,#c6d8ff 45%,transparent 70%);bottom:-18%;right:-10%;animation:drift 30s ease-in-out infinite reverse}
    .stars{position:absolute;inset:0;background-image:radial-gradient(1px 1px at 10% 20%, rgba(255,255,255,.9) 40%,transparent 60%),radial-gradient(1px 1px at 80% 30%,rgba(255,255,255,.8) 40%,transparent 60%);opacity:.26}
    @keyframes drift{0%{transform:translate(0,0)}50%{transform:translate(4%,-2%)}100%{transform:translate(0,0)}}

    .app{position:relative;z-index:1;min-height:100vh;display:grid;place-items:center;padding:32px}
    section{position:absolute;inset:0;display:grid;place-items:center;padding:clamp(16px,3vw,42px);opacity:0;visibility:hidden;transform:translateY(10px);transition:opacity .45s ease,transform .45s ease,visibility .45s}
    section.active{opacity:1;visibility:visible;transform:none}
    .card{width:min(1100px,94vw);background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:clamp(18px,3.6vw,36px);backdrop-filter: blur(8px)}

    .hero{text-align:center}
    .script{font-family:'Great Vibes',cursive;font-size:clamp(42px,8vw,78px);color:var(--brand);margin:0 0 6px;text-shadow:0 14px 40px rgba(255,62,134,.2)}
    .sub{color:var(--muted);font-size:clamp(13px,2.2vw,16px);margin:0}

    .row{display:flex;gap:12px;justify-content:center;align-items:center;margin-top:12px;flex-wrap:wrap}
    .btn{appearance:none;border:0;background:linear-gradient(135deg,var(--brand),var(--brand2));color:#fff;padding:12px 18px;border-radius:12px;font-weight:800;cursor:pointer;box-shadow:0 10px 30px rgba(124,77,255,.18)}
    .btn.ghost{background:#fff;color:#222;box-shadow:none;border:1px solid #eef0ff}
    .muted{color:var(--muted)}

    /* gallery tiles */
    .gallery{display:grid;gap:16px;grid-template-columns:repeat(12,1fr);margin-top:18px}
    .tile{grid-column:span 6;aspect-ratio:4/3;perspective:1000px;position:relative}
    .flip{position:relative;width:100%;height:100%;border-radius:16px;overflow:hidden;cursor:pointer;box-shadow:var(--shadow)}
    .front img{width:100%;height:100%;object-fit:cover;display:block;transition:filter .45s ease,transform .45s ease}
    .overlayPhrase{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;padding:22px;background:linear-gradient(180deg,rgba(10,10,12,.35),rgba(10,10,12,.55));color:#fff;font-weight:800;font-size:clamp(16px,2.6vw,24px);opacity:0;transform:translateY(10px);transition:opacity .35s ease,transform .35s ease,backdrop-filter .35s ease;backdrop-filter: blur(6px) saturate(1.1)}
    .flip.revealed .overlayPhrase{opacity:1;transform:none}
    .flip.revealed .front img{filter: blur(3px) brightness(.55);transform:scale(1.03)}
    @media (max-width:900px){.tile{grid-column:1 / -1}}

    /* game */
    #gameWrap{display:flex;justify-content:center;align-items:center;gap:12px;flex-direction:column}
    canvas#game{display:block;border-radius:14px;background:linear-gradient(180deg,#fff6fb,#eef4ff);border:1px solid #eef0ff;box-shadow:var(--shadow)}
    .hud{display:flex;gap:12px;justify-content:center;margin-top:10px}
    .chip{background:#fff;border-radius:999px;padding:8px 12px;font-weight:800;color:#2c2c3a;border:1px solid #eef0ff}

    /* big phrase */
    #bigPhrase{position:fixed;top:10vh;left:50%;transform:translateX(-50%);z-index:60;background:linear-gradient(90deg,rgba(255,62,134,0.98),rgba(124,77,255,0.95));color:#fff;padding:18px 28px;border-radius:16px;font-size:clamp(20px,3.6vw,36px);font-weight:900;box-shadow:0 18px 50px rgba(0,0,0,.36);opacity:0;transition:opacity .3s ease,transform .3s ease;pointer-events:none;text-align:center;letter-spacing:.6px}
    #bigPhrase.show{opacity:1;transform:translateX(-50%) translateY(0)}

    .toast{position:fixed;left:50%;bottom:28px;transform:translateX(-50%);background:rgba(16,16,32,.96);color:#fff;padding:10px 14px;border-radius:999px;font-weight:700;opacity:0;pointer-events:none;transition:opacity .3s ease;z-index:20}
    .toast.show{opacity:1}

    .cakeWrap{display:grid;gap:14px;justify-items:center}.cakeSvg{width:min(360px,86vw)}.flame{transform-origin:50% 70%;animation:flick .35s infinite ease-in-out alternate}
    @keyframes flick{from{transform:scale(1) translateY(0)}to{transform:scale(1.07) translateY(-1px)}}

    canvas#confettiCanvas{position:fixed;inset:0;pointer-events:none;z-index:50;display:block}

    /* MUSIC UI */
    .music-panel{
      position:fixed; right:18px; bottom:18px; z-index:80;
      display:flex; gap:10px; align-items:center;
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      padding:10px 12px;border-radius:999px;backdrop-filter: blur(6px);
      box-shadow:0 8px 30px rgba(0,0,0,.3);
    }
    .play-big{
      display:inline-grid;place-items:center;width:56px;height:56px;border-radius:999px;background:linear-gradient(135deg,var(--brand),var(--brand2));color:#fff;font-weight:900;font-size:18px;border:0;cursor:pointer;box-shadow:0 10px 30px rgba(124,77,255,.18)
    }
    .play-small{appearance:none;border:0;background:transparent;color:#fff;cursor:pointer;font-weight:800;padding:6px 8px}
    .vol-slider{width:110px}
    .music-state{font-size:12px;color:#fff;opacity:.9;margin-left:6px;min-width:140px;text-align:right}
    .upload-btn{appearance:none;border:0;background:rgba(255,255,255,.06);color:#fff;padding:6px 10px;border-radius:10px;cursor:pointer;font-weight:700}

    /* accessibility focus */
    .flip:focus{outline:3px solid rgba(124,77,255,.18);outline-offset:4px}
  </style>
</head>
<body>
  <div class="bg" aria-hidden="true">
    <div class="blob b1"></div>
    <div class="blob b2"></div>
    <div class="stars"></div>
  </div>

  <div class="app">
    <!-- INTRO -->
    <section id="intro" class="active">
      <div class="card hero">
        <div class="script">Feliz Cumplea√±os, Keysi ‚ú®</div>
        <p class="sub">He preparado algo especial con tus fotos, un juego y una vela para soplar üíù</p>
        <div class="row">
          <button class="btn" id="btnStart">Comenzar</button>
          <button class="btn ghost" id="skipToGallery">Saltar a la galer√≠a</button>
        </div>
        <p class="muted" style="margin-top:8px">La m√∫sica empezar√° cuando presiones ‚ÄúComenzar‚Äù o con el bot√≥n de play abajo. Si falla, puedes subir tu MP3.</p>
      </div>
    </section>

    <!-- INTERMEDIO -->
    <section id="intermedio">
      <div class="card hero">
        <h2 style="margin:0 0 6px">Keysi üíñ</h2>
        <p class="sub">Pasemos por recuerdos lindos, un mini juego con frases bonitas y soplamos la vela para el deseo.</p>
        <div style="margin-top:12px"><button class="btn" onclick="go('galeria')">Ver tus fotos</button></div>
      </div>
    </section>

    <!-- GALER√çA -->
    <section id="galeria">
      <div class="card">
        <div class="hero">
          <h2 style="margin:0 0 6px">Eres Hermosa ‚ú®</h2>
          <p class="sub">Toca la foto para revelar una frase bonita sobre ella.</p>
        </div>

        <div class="gallery" id="gallery">
          <div class="tile"><div class="flip" data-back="Eres incre√≠ble, tu luz me gu√≠a ‚ú®"><div class="front"><img src="https://i.imgur.com/XsZUN78.png" alt="Foto Keysi 1"></div><div class="overlayPhrase"></div></div></div>
          <div class="tile"><div class="flip" data-back="Tu sonrisa cambia los d√≠as grises por colores üåà"><div class="front"><img src="https://i.imgur.com/zDbSk14.png" alt="Foto Keysi 2"></div><div class="overlayPhrase"></div></div></div>
          <div class="tile"><div class="flip" data-back="Contigo todo es m√°s f√°cil y m√°s bonito üíñ"><div class="front"><img src="https://i.imgur.com/fvreaMy.png" alt="Foto Keysi 3"></div><div class="overlayPhrase"></div></div></div>
          <div class="tile"><div class="flip" data-back="Eres arte en movimiento, √∫nica ‚ú®"><div class="front"><img src="https://i.imgur.com/WgbvOp6.png" alt="Foto Keysi 4"></div><div class="overlayPhrase"></div></div></div>
        </div>

        <div class="hero" style="margin-top:16px"><button class="btn" onclick="go('juego')">Ir al juego ‚ù§Ô∏è</button></div>
      </div>
    </section>

    <!-- JUEGO -->
    <section id="juego">
      <div class="card">
        <div class="hero">
          <h2 style="margin:0 0 6px">Atrapa los corazones</h2>
          <p class="sub">Cada coraz√≥n atrapado revela una frase para Keysi. Son pocos ‚Äî disfr√∫talo.</p>
        </div>

        <div id="gameWrap">
          <canvas id="game" width="520" height="700" role="img" aria-label="Juego atrapa corazones"></canvas>
          <div class="hud"><div class="chip">Restantes: <span id="left">0</span></div><div class="chip">Atrapados: <span id="caught">0</span></div></div>
        </div>

        <div class="hero" style="margin-top:12px"><button class="btn" onclick="go('torta')">Continuar üéÇ</button></div>
      </div>
    </section>

    <!-- TORTA -->
    <section id="torta">
      <div class="card">
        <div class="hero"><h2 style="margin:0 0 6px">Pide un deseo, Keysi</h2></div>

        <div class="cakeWrap">
          <svg class="cakeSvg" viewBox="0 0 300 260" xmlns="http://www.w3.org/2000/svg" aria-label="Torta con vela">
            <ellipse cx="150" cy="230" rx="110" ry="18" fill="#e9e7ff" />
            <rect x="60" y="120" width="180" height="80" rx="16" fill="#ffc3d7" />
            <rect x="60" y="120" width="180" height="26" rx="16" fill="#ffe7ef" />
            <path d="M60,145 c20,25 30,-10 50,0 s30,22 50,0 s30,-8 50,0 s20,26 30,0 v15 h-180z" fill="#ffd6e6" opacity=".9" />
            <rect x="142" y="65" width="16" height="55" rx="6" fill="#fff" stroke="#f4f4f9" />
            <circle cx="150" cy="65" r="3" fill="#7c4dff" />
            <g id="flame" class="flame">
              <path d="M150 35 C140 48 143 60 150 66 C157 60 160 48 150 35 Z" fill="url(#gradFlame)" />
              <animate attributeName="opacity" values="1;0.9;1;0.85;1" dur="1.1s" repeatCount="indefinite" />
            </g>
            <defs>
              <radialGradient id="gradFlame" cx="50%" cy="40%" r="60%">
                <stop offset="0%" stop-color="#fff59d"/>
                <stop offset="70%" stop-color="#ff9800"/>
                <stop offset="100%" stop-color="#ff6d00"/>
              </radialGradient>
            </defs>
          </svg>

          <div style="display:flex;gap:12px;align-items:center;">
            <button class="btn" id="btnBlow">Apagar vela</button>
            <div class="muted">Si permites micr√≥fono, tambi√©n puedes soplar</div>
          </div>
        </div>

        <div class="hero" style="margin-top:12px"><button class="btn" onclick="go('final')">Mensaje final ‚ú®</button></div>
      </div>
    </section>

    <!-- FINAL -->
    <section id="final">
      <div class="card hero" style="background: linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.06)); color:#fff;">
        <div class="script" style="color:#ffd1ff">¬°Feliz cumplea√±os, Keysi!</div>
        <p style="font-weight:800;font-size:clamp(22px,4.2vw,36px)">Que tus deseos se cumplan y este a√±o te sorprenda bonito.</p>
        <p class="sub" style="color:#e9e9ff">Con todo mi cari√±o üíñ</p>
        <div style="margin-top:14px"><button class="btn" onclick="go('intro')">Volver al inicio</button></div>
      </div>
    </section>
  </div>

  <!-- big phrase + toast + confetti -->
  <div id="bigPhrase" aria-live="polite"></div>
  <div id="toast" class="toast" role="status" aria-live="polite"></div>
  <canvas id="confettiCanvas"></canvas>

  <!-- main audio element (local fallback) -->
  <audio id="music" src="musica.mp3" preload="auto" crossorigin="anonymous"></audio>

  <!-- MUSIC UI: play button + controls + upload -->
  <div class="music-panel" aria-hidden="false">
    <button id="musicPlay" class="play-big" title="Reproducir m√∫sica">‚ñ∂</button>
    <button id="musicToggle" class="play-small" title="Pausar/continuar">Pause</button>
    <input id="vol" class="vol-slider" type="range" min="0" max="1" step="0.01" value="0.95" aria-label="Volumen" />
    <button id="uploadBtn" class="upload-btn" title="Subir MP3">Subir audio</button>
    <div class="music-state" id="musicState">Estado: detenido</div>
    <input id="filePicker" type="file" accept="audio/*" style="display:none" />
  </div>

  <script>
  /* =========================
     Navigation & small helpers
     ========================= */
  const sections = [...document.querySelectorAll('section')];
  function go(id){
    sections.forEach(s => s.classList.toggle('active', s.id === id));
    if(id === 'juego') startGameOnce();
    if(id === 'final') startConfetti();
    window.scrollTo({top:0,behavior:'smooth'});
  }
  document.getElementById('skipToGallery').addEventListener('click', ()=> go('galeria'));

  /* =========================
     Music robust player + local upload fallback
     ========================= */

  // CONFIG: resource fallbacks (use your Dropbox/Drive links or local file)
  const dropboxUrl = 'https://www.dropbox.com/scl/fi/r36g0mudxsoykub5oai6e/Mujer-de-Rizos-Chico-cometa-video-lyrics.mp3?rlkey=hy8zdqpzk1x5as87xierh9ott&dl=1';
  const driveFileId = '1uAWh2_j0g4IZOTOtbE58fj0Nq0iGkwFn';
  const driveUrlDirect1 = `https://docs.google.com/uc?export=download&id=${driveFileId}`;
  const driveUrlDirect2 = `https://drive.google.com/uc?export=download&id=${driveFileId}`;
  const fallbackVocaroo = 'https://media1.vocaroo.com/mp3/15EcG40ouSeH';

  const btnStart = document.getElementById('btnStart');
  const musicEl = document.getElementById('music');
  const musicPlayBtn = document.getElementById('musicPlay');
  const musicToggle = document.getElementById('musicToggle');
  const volSlider = document.getElementById('vol');
  const musicState = document.getElementById('musicState');
  const uploadBtn = document.getElementById('uploadBtn');
  const filePicker = document.getElementById('filePicker');

  // track objectURL so we can revoke
  let _objectURL = null;

  function audioToast(msg){
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.classList.add('show');
    clearTimeout(t._audioT);
    t._audioT = setTimeout(()=> t.classList.remove('show'), 2400);
    musicState.textContent = 'Estado: ' + msg;
  }

  function stopCurrentAudio(){
    try{
      if(window._playingAudio && typeof window._playingAudio.pause === 'function'){
        window._playingAudio.pause();
        window._playingAudio.currentTime = 0;
      }
    }catch(e){}
    try{
      if(window._playingSource && window._audioCtx){
        try{ window._playingSource.stop(0); }catch(e){}
        try{ window._playingSource.disconnect(); }catch(e){}
        window._playingSource = null;
      }
    }catch(e){}
    // revoke previous object URL if any when stopping and source isn't used
    if(_objectURL){
      try{ URL.revokeObjectURL(_objectURL); }catch(e){}
      _objectURL = null;
    }
    window._playingAudio = null;
  }

  // Strategy 1: play the <audio> element (local "musica.mp3" or set later via upload)
  async function tryPlayLocalAudio(){
    try{
      musicEl.crossOrigin = 'anonymous';
      musicEl.loop = true;
      musicEl.volume = Number(volSlider.value) || 0.95;
      if(window._audioCtx && typeof window._audioCtx.resume === 'function'){
        try{ await window._audioCtx.resume(); }catch(e){}
      }
      const p = musicEl.play();
      if(p instanceof Promise) await p;
      window._playingAudio = musicEl;
      audioToast('M√∫sica local reproduci√©ndose');
      return true;
    }catch(err){
      console.warn('tryPlayLocalAudio failed', err);
      return false;
    }
  }

  // Strategy 2: create HTMLAudio from URL
  async function tryPlayAudioElementFallback(url, timeout = 9000){
    return new Promise((resolve) => {
      let settled = false;
      const a = new Audio();
      a.crossOrigin = 'anonymous';
      a.preload = 'auto';
      a.src = url;
      a.loop = true;
      a.volume = Number(volSlider.value) || 0.92;

      function clean(ok){
        if(settled) return;
        settled = true;
        a.removeEventListener('playing', onPlaying);
        a.removeEventListener('error', onError);
        clearTimeout(timer);
        if(!ok){ try{ a.pause(); }catch(e){} } else { window._playingAudio = a; }
        resolve(ok);
      }
      function onPlaying(){ clean(true); console.log('Audio element playing', url); audioToast('M√∫sica reproduci√©ndose'); }
      function onError(e){ console.warn('Audio playback error', url, e); clean(false); }

      a.addEventListener('playing', onPlaying);
      a.addEventListener('error', onError);

      const playPromise = a.play();
      if(playPromise instanceof Promise){
        playPromise.then(()=>{/* handled by playing */}).catch(err=>{ console.warn('play() rejected for', url, err); });

      }
      const timer = setTimeout(()=> {
        console.warn('Audio fallback timeout for', url);
        clean(false);
      }, timeout);
    });
  }

  // Strategy 3: fetch+decode via WebAudio (needs CORS)
  async function tryPlayViaWebAudio(url, opts = {timeout:10000}){
    try{
      if(!window._audioCtx) window._audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      const ctx = window._audioCtx;
      if(ctx.state === 'suspended') try{ await ctx.resume(); }catch(e){}

      const controller = new AbortController();
      const tid = setTimeout(()=> controller.abort(), opts.timeout || 10000);
      const resp = await fetch(url, { mode:'cors', cache:'no-cache', signal: controller.signal });
      clearTimeout(tid);
      if(!resp.ok) throw new Error('Fetch failed: ' + resp.status);
      const ab = await resp.arrayBuffer();
      const decoded = await ctx.decodeAudioData(ab.slice(0));
      const src = ctx.createBufferSource();
      src.buffer = decoded;
      src.loop = true;
      const gain = ctx.createGain();
      gain.gain.value = Number(volSlider.value) || 0.95;
      src.connect(gain).connect(ctx.destination);
      stopCurrentAudio();
      src.start(0);
      window._playingSource = src;
      window._playingAudio = null;
      window._gainNode = gain; // store reference for volume control
      audioToast('M√∫sica reproduci√©ndose (WebAudio)');
      console.log('Playing via WebAudio from', url);
      return true;
    }catch(err){
      console.warn('tryPlayViaWebAudio failed for', url, err);
      return false;
    }
  }

  // Orchestrator tries multiple sources (all triggered by user gesture)
  async function startAudioRobust(){
    stopCurrentAudio();
    audioToast('Iniciando m√∫sica...');
    // 1) local <audio>
    const okLocal = await tryPlayLocalAudio();
    if(okLocal) return true;

    // 2) Dropbox
    audioToast('Intentando Dropbox...');
    const okDrop = await tryPlayAudioElementFallback(dropboxUrl, 9000);
    if(okDrop) return true;

    // 3) Drive attempts
    const driveUrls = [driveUrlDirect1, driveUrlDirect2];
    for(const u of driveUrls){
      audioToast('Intentando Drive...');
      const okDrive = await tryPlayAudioElementFallback(u, 9000);
      if(okDrive) return true;
    }

    // 4) Vocaroo fallback
    audioToast('Intentando fallback p√∫blico...');
    const okVoc = await tryPlayAudioElementFallback(fallbackVocaroo, 8000);
    if(okVoc) return true;

    // 5) WebAudio fetch/decode (try dropbox + drive + vocaroo)
    for(const u of [dropboxUrl, ...driveUrls, fallbackVocaroo]){
      audioToast('Intentando reproducci√≥n avanzada (WebAudio)...');
      const okW = await tryPlayViaWebAudio(u, {timeout:11000});
      if(okW) return true;
    }

    audioToast('No se pudo reproducir el audio autom√°ticamente. Por favor sube tu MP3.');
    // return false so caller can trigger file picker
    return false;
  }

  // When Play button pressed: try robust pipeline, if false, prompt to upload local mp3
  musicPlayBtn.addEventListener('click', async () => {
    musicPlayBtn.disabled = true;
    const prevText = musicPlayBtn.textContent;
    musicPlayBtn.textContent = '...';
    const ok = await startAudioRobust();
    musicPlayBtn.disabled = false;
    musicPlayBtn.textContent = ok ? '‚ô™' : '‚ñ∂';
    if(!ok){
      // open file picker automatically to help user (most reliable)
      filePicker.click();
    }
  });

  // If Comenzar pressed, also attempt audio (but still navigate)
  btnStart.addEventListener('click', async () => {
    try{ if(window._audioCtx && window._audioCtx.state === 'suspended') await window._audioCtx.resume(); } catch(e){}
    startAudioRobust().finally(()=> go('intermedio'));
  });

  // Pause/resume toggle (works for HTMLAudio and for WebAudio via context suspend/resume)
  musicToggle.addEventListener('click', async ()=>{
    if(window._playingAudio){
      try{
        if(window._playingAudio.paused){
          await window._playingAudio.play();
          audioToast('Reproduciendo');
          musicToggle.textContent = 'Pause';
        } else {
          window._playingAudio.pause();
          audioToast('Pausado');
          musicToggle.textContent = 'Play';
        }
      }catch(e){
        console.warn('toggle play error', e);
        audioToast('No se pudo cambiar reproducci√≥n');
      }
    } else if(window._playingSource && window._audioCtx){
      const ctx = window._audioCtx;
      if(ctx.state === 'running'){
        try{ await ctx.suspend(); audioToast('Pausado (WebAudio)'); musicToggle.textContent = 'Play'; }catch(e){ audioToast('Error pausa WebAudio'); }
      } else {
        try{ await ctx.resume(); audioToast('Reproduciendo (WebAudio)'); musicToggle.textContent = 'Pause'; }catch(e){ audioToast('Error reanudar WebAudio'); }
      }
    } else {
      audioToast('No hay audio activo');
    }
  });

  // Volume sync
  volSlider.addEventListener('input', ()=>{
    const v = Number(volSlider.value);
    if(window._playingAudio) try{ window._playingAudio.volume = v; }catch(e){}
    if(window._gainNode) try{ window._gainNode.gain.value = v; }catch(e){}
  });

  // Upload button opens file picker
  uploadBtn.addEventListener('click', ()=> filePicker.click());

  // When user picks a local file: createObjectURL and play via <audio> element (reliable)
  filePicker.addEventListener('change', async (e)=>{
    const f = e.target.files && e.target.files[0];
    if(!f) return;
    if(!f.type.startsWith('audio/')) { audioToast('Archivo no es audio'); return; }

    stopCurrentAudio();
    // revoke previous
    if(_objectURL){ try{ URL.revokeObjectURL(_objectURL); }catch(e){} _objectURL = null; }
    _objectURL = URL.createObjectURL(f);
    musicEl.src = _objectURL;
    musicEl.volume = Number(volSlider.value) || 0.95;
    try{
      await musicEl.play();
      window._playingAudio = musicEl;
      audioToast('Reproduciendo audio subido');
      musicPlayBtn.textContent = '‚ô™';
    }catch(err){
      console.warn('play uploaded file failed', err);
      audioToast('No se pudo reproducir el archivo subido');
    }
  });

  /* =========================
     Gallery: overlay phrases
     ========================= */
  document.querySelectorAll('.flip').forEach(f => {
    const phrase = f.dataset.back || '';
    const overlay = f.querySelector('.overlayPhrase');
    if(overlay) overlay.textContent = phrase;
    f.addEventListener('click', ()=> f.classList.toggle('revealed'));
    f.addEventListener('keydown', (e)=> { if(e.key === 'Enter' || e.key === ' ') { e.preventDefault(); f.classList.toggle('revealed'); }});
    f.setAttribute('tabindex','0');
  });

  /* =========================
     Game: Atrapa Corazones
     ========================= */
  const canvas = document.getElementById('game');
  const g = canvas.getContext('2d');
  const leftEl = document.getElementById('left');
  const caughtEl = document.getElementById('caught');
  const TOAST = document.getElementById('toast');
  const BIG = document.getElementById('bigPhrase');

  const PHRASES = [
    'Tu risa es mi lugar favorito ‚ú®',
    'Gracias por existir üíñ',
    'Brillas m√°s que el sol üåû',
    'Eres magia en persona ‚ú®',
    'Siempre, a tu lado üí´',
    'Me encantas tal como eres üå∏',
  ];

  let targetHearts = PHRASES.length;
  let caught = 0;
  let hearts = [];
  let spawned = 0;
  let lastSpawnTs = 0;
  const spawnInterval = 1200;
  let gameActive = false;

  const W = canvas.width, H = canvas.height;
  let basket = { x: W/2 - 55, y: H - 48, w: 110, h: 24, vx: 0 };

  function resetGame(){ hearts = []; spawned = 0; caught = 0; lastSpawnTs = 0; gameActive = true; leftEl.textContent = targetHearts; caughtEl.textContent = '0'; }
  function startGameOnce(){ resetGame(); }

  function spawnHeart(){
    if(spawned >= targetHearts) return;
    const x = 30 + Math.random() * (W - 60);
    const id = Date.now() + Math.random();
    const phraseIndex = spawned;
    hearts.push({ id, x, y: -40, vy: 1.6 + Math.random()*0.9, phraseIndex });
    spawned++; updateLeft();
  }
  function updateLeft(){ leftEl.textContent = Math.max(0, targetHearts - caught - hearts.length); }

  CanvasRenderingContext2D.prototype.roundRect = function (x,y,w,h,r){
    if(w < 2*r) r = w/2;
    if(h < 2*r) r = h/2;
    this.beginPath();
    this.moveTo(x+r,y);
    this.arcTo(x+w,y,x+w,y+h,r);
    this.arcTo(x+w,y+h,x,y+h,r);
    this.arcTo(x,y+h,x,y,r);
    this.arcTo(x,y,x+w,y,r);
    this.closePath();
    return this;
  };

  function drawBasket(){
    g.fillStyle = '#ff4d85';
    g.roundRect(basket.x, basket.y, basket.w, basket.h, 10);
    g.fill();
    g.fillStyle = '#ffd6e6';
    g.fillRect(basket.x, basket.y, basket.w, 4);
  }
  function drawHeart(x,y,scale=1){
    g.save();
    g.translate(x,y);
    g.scale(scale,scale);
    g.fillStyle = '#ff2b5e';
    g.beginPath();
    g.moveTo(0,-10);
    g.bezierCurveTo(-12,-24,-32,-4,0,16);
    g.bezierCurveTo(32,-4,12,-24,0,-10);
    g.fill();
    g.restore();
  }

  let bigTimer = null;
  function showBigPhrase(text){
    BIG.textContent = text;
    BIG.classList.add('show');
    clearTimeout(bigTimer);
    bigTimer = setTimeout(()=> BIG.classList.remove('show'), 2400);
  }
  function showToast(msg){
    TOAST.textContent = msg;
    TOAST.classList.add('show');
    clearTimeout(showToast._t);
    showToast._t = setTimeout(()=> TOAST.classList.remove('show'), 1800);
  }

  function update(ts){
    if(!lastSpawnTs) lastSpawnTs = ts;
    if(gameActive && spawned < targetHearts && (ts - lastSpawnTs) >= spawnInterval){
      spawnHeart(); lastSpawnTs = ts;
    }
    hearts.forEach(h => { h.y += h.vy; });
    hearts.forEach(h => {
      if(!h.caught && (h.y > basket.y - 8) && (h.x > basket.x) && (h.x < (basket.x + basket.w))){
        h.caught = true;
        const phrase = PHRASES[h.phraseIndex] || PHRASES[Math.floor(Math.random()*PHRASES.length)];
        showBigPhrase(phrase); showToast('Frase revelada');
        caught++; caughtEl.textContent = caught;
      }
    });
    hearts = hearts.filter(h => !h.caught && h.y < H + 40);
    updateLeft(); render();
    if(spawned >= targetHearts && hearts.length === 0){
      gameActive = false;
      if(caught >= targetHearts) setTimeout(()=> showToast('¬°Muy bien! Ahora puedes soplar la vela üéÇ'), 600);
    }
    requestAnimationFrame(update);
  }

  function render(){
    const grd = g.createLinearGradient(0,0,0,H);
    grd.addColorStop(0,'#fff6fb'); grd.addColorStop(1,'#f0f7ff');
    g.fillStyle = grd; g.fillRect(0,0,W,H);
    hearts.forEach(h => drawHeart(h.x,h.y,1));
    drawBasket();
  }
  requestAnimationFrame(update);

  // controls
  canvas.addEventListener('mousemove', (e)=>{
    const r = canvas.getBoundingClientRect();
    const relX = (e.clientX - r.left) * (W / r.width);
    basket.x = relX - basket.w/2; clampBasket();
  });
  canvas.addEventListener('touchmove', (e)=>{
    const t = e.touches[0]; const r = canvas.getBoundingClientRect();
    const relX = (t.clientX - r.left) * (W / r.width);
    basket.x = relX - basket.w/2; clampBasket(); e.preventDefault();
  }, {passive:false});
  window.addEventListener('keydown', (e)=>{ if(e.key === 'ArrowLeft') basket.vx = -6; if(e.key === 'ArrowRight') basket.vx = 6; });
  window.addEventListener('keyup', (e)=>{ if(e.key==='ArrowLeft' || e.key==='ArrowRight') basket.vx = 0; });
  function clampBasket(){ if(basket.x < 8) basket.x = 8; if(basket.x + basket.w > W - 8) basket.x = W - 8 - basket.w; }
  setInterval(()=>{ basket.x += basket.vx; clampBasket(); }, 16);

  document.getElementById('left').textContent = targetHearts;
  document.getElementById('caught').textContent = '0';

  /* =========================
     Vela + micr√≥fono (apagar vela)
     ========================= */
  const flame = document.getElementById('flame');
  const btnBlow = document.getElementById('btnBlow');
  let blown = false;
  function extinguish(){
    if(blown) return; blown = true;
    try{ if(flame && flame.parentNode) flame.parentNode.removeChild(flame); }catch(e){}
    burstConfetti(); showToast('¬°Vela apagada! üéâ');
  }
  btnBlow.addEventListener('click', extinguish);

  if(navigator.mediaDevices && navigator.mediaDevices.getUserMedia){
    navigator.mediaDevices.getUserMedia({ audio:true, echoCancellation:true }).then(stream=>{
      const ctxA = new (window.AudioContext||window.webkitAudioContext)();
      const src = ctxA.createMediaStreamSource(stream);
      const analyser = ctxA.createAnalyser(); analyser.fftSize = 1024;
      src.connect(analyser);
      const buf = new Uint8Array(analyser.fftSize);
      let avg = 0;
      (function listen(){
        analyser.getByteTimeDomainData(buf);
        let sum = 0;
        for(let i=0;i<buf.length;i++){ const v=(buf[i]-128)/128; sum+=v*v; }
        const rms = Math.sqrt(sum / buf.length);
        avg = avg*0.86 + rms*0.14;
        if(avg > 0.09) extinguish();
        requestAnimationFrame(listen);
      })();
    }).catch(()=>{/* permiso denegado o no disponible */});
  }

  /* =========================
     Confetti
     ========================= */
  const confCanvas = document.getElementById('confettiCanvas');
  const cx = confCanvas.getContext('2d');
  let confetti = [], confLoop = false, confTimer = null;

  function makeConfetti(n=120){
    const w = confCanvas.width = innerWidth, h = confCanvas.height = innerHeight;
    for(let i=0;i<n;i++){
      confetti.push({x:Math.random()*w,y:-10-Math.random()*h*0.5,vx:-1+Math.random()*2,vy:2+Math.random()*3,s:5+Math.random()*6,r:Math.random()*Math.PI*2,life:0});
    }
  }
  function drawConf(){
    const w = confCanvas.width = innerWidth, h = confCanvas.height = innerHeight;
    cx.clearRect(0,0,w,h);
    for(let i=confetti.length-1;i>=0;i--){
      const p = confetti[i];
      p.x += p.vx; p.y += p.vy; p.r += 0.12; p.life++;
      cx.save(); cx.translate(p.x,p.y); cx.rotate(p.r);
      cx.fillStyle = `hsl(${(p.x+p.y)%360},85%,${50 + (p.s/3)}%)`;
      cx.fillRect(-p.s/2,-p.s/2,p.s,p.s);
      cx.restore();
      if(p.y > h + 40 || p.life > 300) confetti.splice(i,1);
    }
  }
  function startConfetti(duration=7000){
    if(confLoop) return; confLoop = true; makeConfetti(200);
    (function loop(){ if(!confLoop) return; drawConf(); requestAnimationFrame(loop); })();
    clearTimeout(confTimer); confTimer = setTimeout(()=> confLoop = false, duration);
  }
  function burstConfetti(){
    makeConfetti(90); let t=0;
    (function loop(){ drawConf(); t++; if(t<120) requestAnimationFrame(loop); })();
  }
  function resizeCanvas(){ confCanvas.width = innerWidth; confCanvas.height = innerHeight; }
  window.addEventListener('resize', resizeCanvas); resizeCanvas();

  /* =========================
     Small helpers
     ========================= */
  document.querySelector('.btn.ghost')?.addEventListener('click', ()=> {
    const first = document.querySelector('.flip');
    if(first) setTimeout(()=> first.focus(), 400);
  });

  // Augment tryPlayViaWebAudio to store gain node (already done above)
  // (No further action needed.)
  </script>
</body>
</html>
